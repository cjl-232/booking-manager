<!-- next step: work out dynamic (and usable) radio button generation -->

<!DOCTYPE html>
<html>
  <head>
    <title>Desk Booking</title>
    <meta charset="utf-8">
    <meta content="width = device-width, initial-scale = 1" name="viewport">
    {% load static %}
    {% load compress %}
    <link rel="stylesheet" href="{% static 'jquery.datetimepicker.css' %}"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css" integrity="sha384-Vn0xiUc12vxlhJvgdGKbK8mGesCKN5jyO+2jqsBW7B+VBOpI+mBb9psuN4eQ1qAT" crossorigin="anonymous">
    <link href="{% static 'stylesheet.css' %}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.js" integrity="sha384-BBTxy78shItxVf6Hz4VlUqO0A+B1lgtfSgFCwrn3Xb95oVD5LNI1qrqMceSZ+w+7" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="{% static 'jquery.js' %}"></script>
    <script src="{% static 'jquery.datetimepicker.full.js' %}"></script>
  </head>
  <body>
  <input type="radio" class="btn-check" name="options" id="option1" autocomplete="off" checked>
<label class="btn btn-secondary" for="option1">Checked</label>

<input type="radio" class="btn-check" name="options" id="option2" autocomplete="off">
<label class="btn btn-secondary" for="option2">Radio</label>

<input type="radio" class="btn-check" name="options" id="option3" autocomplete="off" disabled>
<label class="btn btn-secondary" for="option3">Disabled</label>

<input type="radio" class="btn-check" name="options" id="option4" autocomplete="off">
<label class="btn btn-secondary" for="option4">Radio</label>
    <div class="container">
      <div class="row">
        <div class="col-4">
          <form>
            <div class="form-group">
              <div for="site_selection" class="form-label">Select location:</div>
              <select id="site_selection" class="form-select">
                {% for site in sites %}
                  {% if forloop.first %}
                    <option selected value="{{site.id}}" label="{{site.name}}">
                  {% endif %}
                  {% if not forloop.first %}
                    <option value="{{site.id}}" label="{{site.name}}">
                  {% endif %}
                {% endfor %}
                <option value="kirby" label="Kirby">
              </select>
            </div>
            <div class="form-group">
              <div for="start_datetime" class="form-label">Select booking start:</div>
              <input type="text" id="start_datetime" class="form-control">
            </div>
            <div class="form-group">
              <div for="end_datetime" class="form-label">Select booking end:</div>
              <input type="text" id="end_datetime" class="form-control">
            </div>
          </form>
        </div>
        <div class="col-8">
          <form>
            <div class="form-group">
              <div id="date_range" for="canvas" class="form-label"></div>
              <canvas id="canvas" height="150" width="300"></canvas>
            </div>
            <div id="floor_buttons" class="btn-group btn-group-toggle">  
              
            </div>
          </form>
        </div>
       </div>
    </div>
    
    <script>
      alert(JSON.parse(document.getElementById('test_script').textContent));
    </script>
  
    <!-- Date/time picker initialisation: -->
    <script>
      jQuery(function(){
      
        function same_date(lhs, rhs) {
          return lhs.getDate() == rhs.getDate() && lhs.getMonth() == rhs.getMonth() && lhs.getFullYear() == rhs.getFullYear();
        };
        
        function format_date(date) {
          [year, month, day, hour, minute] = [
            date.getFullYear(),
            date.getMonth() + 1,
            date.getDate(),
            date.getHours(),
            date.getMinutes(),
          ];
          date_component = [
            year, 
            month.toString().padStart(2, '0'), 
            day.toString().padStart(2, '0'),
          ].join('-');
          time_component = [
            hour.toString().padStart(2, '0'),
            minute.toString().padStart(2, '0'),
          ].join(':');
          return date_component + " " + time_component;
        };
        
        function get_date_range_text() {
          var result = "Availability from ";
          result += format_date($("#start_datetime").datetimepicker('getValue'));
          result += " to "; 
          result += format_date($("#end_datetime").datetimepicker('getValue'));
          result += ":"
          return result;
        };      
       
        jQuery("#start_datetime").datetimepicker({
          format: 'Y-m-d h:m',
          inline: true,
          step: 30,
          minDate: 0,
          defaultTime: '09:00',
          onChangeDateTime: function(datetime) {
            
            datetime.setMinutes(30 * Math.floor(datetime.getMinutes() / 30), 0);
            
            const end_datetime = $('#end_datetime').datetimepicker('getValue');
            const min_end_datetime = new Date(datetime);
            min_end_datetime.setMinutes(min_end_datetime.getMinutes() + 30);
                                
            $("#end_datetime").datetimepicker("setOptions", {
              minDate: min_end_datetime,
              minTime: same_date(datetime, min_end_datetime) ? min_end_datetime : false,
              value: (end_datetime < min_end_datetime) ? min_end_datetime : null,
            });
            $('#date_range').text(get_date_range_text());
          }
        });
        
        jQuery("#end_datetime").datetimepicker({
          inline: true,
          step: 30,
          minDate: 0,
          defaultTime: '17:30',
          onChangeDateTime: function(datetime) {
          
            datetime.setMinutes(30 * Math.floor(datetime.getMinutes() / 30), 0);
            
            const start_datetime = $('#start_datetime').datetimepicker('getValue');
            const max_start_datetime = new Date(datetime);
            max_start_datetime.setMinutes(max_start_datetime.getMinutes() - 30);
            
            const min_end_datetime = new Date(start_datetime);
            min_end_datetime.setMinutes(min_end_datetime.getMinutes() + 30);

            $("#end_datetime").datetimepicker("setOptions", {
              minDate: min_end_datetime,
              minTime: (same_date(datetime, min_end_datetime)) ? min_end_datetime : false,
              value: (datetime < min_end_datetime) ? min_end_datetime : null
            });
            $('#date_range').text(get_date_range_text());
          }
        });
        
        
        
        $('#date_range').text(get_date_range_text());
      });
      
    </script>
    
    <!-- Canvas and floor button group code: -->
    {% compress js %}
    <script>
    
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');
      const floor_buttons = document.getElementById('floor_buttons');
      const plan_image = document.createElement('img');
      
      function refreshCanvas(floor) {
      
        //Clear the canvas and apply the background image:
        plan_image.src = floor.plan;
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.drawImage(canvas_backdrop, 0, 0);
        
        //Retrieve desk information:
        const url = "{% url 'get_desks' %}" + "/" + floor.id + "1";
        console.log(url);
        return;
        const response = fetch(
          url,
          {
              method: "GET",
              headers: {
                "X-Requested-With": "XMLHttpRequest",
              },
          });
          console.log(response);
      };
      refreshCanvas({'id': 1, 'canvas_backdrop': "floor_plans/friends.jpg"});
      
      function createButtons(floors) {
      
        floor_buttons.replaceChildren();
        for (var i = 0; i < floors.length; i++) {
        
          var btn = document.createElement('input');
          btn.type = 'radio';
          btn.name = 'floor_buttons';
          btn.id = 'floor_button' + i;
          btn.value = floors[i].plan;
          if (i == 0) {
            btn.checked = true;
            btn.classList.add('checked');
          };
          btn.addEventListener('click', function(e) {
            for (var sibling of this.parentNode.children) {
              sibling.classList.remove('checked');
            };
            this.classList.add('checked');
          });
        };
      };
  
    </script>
    {% endcompress %}
    <script type="module">
      import { createButtons } from "{% static 'desks/floor_load_functions.js' %}";
      jQuery(function(){
      
        function getSitePlans(e) {
          const site_id = this.value;
          const url = "{% url 'get_plans' %}" + "?site=" + site_id;
          const query = fetch(
            url,
            {
              method: "GET",
              headers: {
                "X-Requested-With": "XMLHttpRequest",
              },
            })
            .then(response => response.json())
            .then(data => createButtons(
              data.plans, 
              document.getElementById('floor_buttons'),
              document.getElementById('canvas'))
            )
          };
        $('#site_selection').on('load change', getSitePlans);
      });
    </script>
    
    <!-- Floor button group code: -->
    
    
    
  </body>
</html>